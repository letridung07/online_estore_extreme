{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Analytics Dashboard</h1>
    
    <!-- Sales Trends -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">Sales Trends</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3>Last 30 Days</h3>
                    <canvas id="salesChart30Days" aria-label="Sales trends for the last 30 days">Sales trends for the last 30 days chart</canvas>
                </div>
                <div class="col-md-6">
                    <h3>Last 12 Months</h3>
                    <canvas id="salesChart12Months" aria-label="Sales trends for the last 12 months">Sales trends for the last 12 months chart</canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Products -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">Popular Products</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3>Top Selling Products</h3>
                    <canvas id="topProductsChart" aria-label="Top selling products">Top selling products chart</canvas>
                </div>
                <div class="col-md-6">
                    <h3>Most Viewed Products</h3>
                    <canvas id="mostViewedChart" aria-label="Most viewed products">Most viewed products chart</canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- User Engagement -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">User Engagement</h2>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h3>Average Rating</h3>
                    <p class="display-4">{{ avg_rating|floatformat:1 }}</p>
                </div>
                <div class="col-md-4">
                    <h3>Total Views</h3>
                    <p class="display-4">{{ total_views }}</p>
                </div>
                <div class="col-md-4">
                    <h3>Total Reviews</h3>
                    <p class="display-4">{{ total_reviews }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Overview -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title mb-0">Inventory Overview</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3>Low Stock Products (Less than 10)</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in low_stock_products %}
                            <tr class="{% if product.stock == 0 %}table-danger{% endif %}">
                                <td>{{ product.name }}</td>
                                <td>{{ product.stock }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2">No low stock products.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6 text-center">
                    <h3>Out of Stock Products</h3>
                    <p class="display-4">{{ out_of_stock_products }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ sales_data|json_script:"salesData30Days" }}
{{ monthly_sales|json_script:"salesData12Months" }}
{{ top_products|json_script:"topProducts" }}
{{ most_viewed|json_script:"mostViewed" }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sales Chart - Last 30 Days
        const salesData30DaysRaw = JSON.parse(document.getElementById('salesData30Days').textContent);
        const salesData30Days = {
            labels: salesData30DaysRaw.length > 0 ? salesData30DaysRaw.map(item => item.day) : ["No data"],
            datasets: [{
                label: 'Sales ($)',
                data: salesData30DaysRaw.length > 0 ? salesData30DaysRaw.map(item => item.total || 0) : [0],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        new Chart(document.getElementById('salesChart30Days'), {
            type: 'line',
            data: salesData30Days,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Sales Chart - Last 12 Months
        const salesData12MonthsRaw = JSON.parse(document.getElementById('salesData12Months').textContent);
        const salesData12Months = {
            labels: salesData12MonthsRaw.length > 0 ? salesData12MonthsRaw.map(item => item.month) : ["No data"],
            datasets: [{
                label: 'Sales ($)',
                data: salesData12MonthsRaw.length > 0 ? salesData12MonthsRaw.map(item => item.total || 0) : [0],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        new Chart(document.getElementById('salesChart12Months'), {
            type: 'line',
            data: salesData12Months,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Top Products Chart
        const topProductsRaw = JSON.parse(document.getElementById('topProducts').textContent);
        const topProductsData = {
            labels: topProductsRaw.length > 0 ? topProductsRaw.map(item => item.product__name) : ["No data"],
            datasets: [{
                label: 'Quantity Sold',
                data: topProductsRaw.length > 0 ? topProductsRaw.map(item => item.total_quantity || 0) : [0],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        };

        new Chart(document.getElementById('topProductsChart'), {
            type: 'bar',
            data: topProductsData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Most Viewed Products Chart
        const mostViewedRaw = JSON.parse(document.getElementById('mostViewed').textContent);
        const mostViewedData = {
            labels: mostViewedRaw.length > 0 ? mostViewedRaw.map(item => item.product__name) : ["No data"],
            datasets: [{
                label: 'View Count',
                data: mostViewedRaw.length > 0 ? mostViewedRaw.map(item => item.view_count || 0) : [0],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };

        new Chart(document.getElementById('mostViewedChart'), {
            type: 'bar',
            data: mostViewedData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}
